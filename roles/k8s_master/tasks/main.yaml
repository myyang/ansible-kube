---

- name: clear previous k8s certificates
  file: path={{K8S_DIR}}{{K8S_VERSION}}/ssl state=absent

- name: promise k8s certificates
  file: path={{K8S_DIR}}{{K8S_VERSION}}/ssl state=directory recurse=yes owner=root group=root

- name: copy ca-file
  copy: src=ssl/k8s/_ssl/ca.crt dest={{K8S_DIR}}{{K8S_VERSION}}/ssl/ca.crt owner=root group=root mode=0600

- name: copy server crt
  copy: src=ssl/k8s/_ssl/server.crt dest={{K8S_DIR}}{{K8S_VERSION}}/ssl/server.crt owner=root group=root mode=0600

- name: copy server key
  copy: src=ssl/k8s/_ssl/server.key dest={{K8S_DIR}}{{K8S_VERSION}}/ssl/server.key owner=root group=root mode=0600
  
- name: Config kube-api-server service
  template:
    src: kube-api-server.service.j2
    dest: /lib/systemd/system/kube-api-server.service
    owner: root
    group: root
    mode: 0644

- name: Start/Restart kube-api-server service
  systemd: name=kube-api-server state=restarted daemon_reload=yes enabled=yes

- name: Config kube-controller-manager service
  template:
    src: kube-controller-manager.service.j2
    dest: /lib/systemd/system/kube-controller-manager.service
    owner: root
    group: root
    mode: 0644

- name: Start/Restart kube-controller-manager service
  systemd: name=kube-controller-manager state=restarted daemon_reload=yes enabled=yes

- name: Config kube-scheduler service
  template:
    src: kube-scheduler.service.j2
    dest: /lib/systemd/system/kube-scheduler.service
    owner: root
    group: root
    mode: 0644

- name: Start/Restart kube-scheduler service
  systemd: name=kube-scheduler state=restarted daemon_reload=yes enabled=yes
